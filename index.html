<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Monthly Transaction (Safety Fixed)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
    :root { 
      --h:42px; --r:10px; --primary: #6366f1; --secondary: #10b981; --danger: #ef4444; 
      --bg-body: linear-gradient(135deg,#eef2f7,#f9fafb);
      --bg-card: #ffffff; --text-main: #1f2937; --text-label: #374151; --border-color: #d1d5db; --bg-input: #ffffff;
    }
    body.dark {
      --bg-body: #020617; --bg-card: #0f172a; --text-main: #f8fafc; --text-label: #94a3b8; --border-color: #334155; --bg-input: #1e293b;
    }
    body { font-family:'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); padding:15px; margin:0; min-height: 100vh; transition: background 0.3s; }
    form { background: var(--bg-card); max-width:400px; margin:auto; padding:20px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.1); border: 1px solid var(--border-color); position: relative; }
    #statusDot { position: absolute; top: 20px; right: 20px; width: 10px; height: 10px; border-radius: 50%; background: #94a3b8; }
    #statusDot.online { background: var(--secondary); box-shadow: 0 0 8px var(--secondary); }
    #statusDot.offline { background: var(--danger); box-shadow: 0 0 8px var(--danger); }
    h3 { text-align:center; margin: 0 0 15px 0; font-weight:600; }
    label { font-size:12px; font-weight:600; margin-top:12px; display:block; color: var(--text-label); }
    input, select, button { width:100%; height:var(--h); margin-top:5px; padding:0 10px; border-radius:var(--r); border:1px solid var(--border-color); box-sizing:border-box; font-size:13px; background: var(--bg-input); color: var(--text-main); }
    input:focus, select:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(99,102,241,.1); }
    
    /* Inline Validation */
    form.was-validated input:invalid, form.was-validated select:invalid { border-color: var(--danger) !important; background: rgba(239, 68, 68, 0.05); }
    
    .btn-group { display: grid; grid-template-columns: 1.2fr 1fr; gap: 8px; margin-top: 20px; }
    button[type="submit"] { background: var(--primary); color: #fff; border: none; font-weight: 600; cursor: pointer; }
    button[type="submit"]:disabled { opacity: 0.5; cursor: not-allowed; }
    #btnRepeat { background: var(--bg-input); color: var(--secondary); border: 1px solid var(--secondary); font-weight: 600; cursor: pointer; }
    .payment-row-wrapper { margin-bottom: 12px; border-bottom: 1px dashed var(--border-color); padding-bottom: 12px; }
    .payment-row { display: grid; grid-template-columns: 0.7fr 1.1fr 75px 35px; gap: 6px; align-items: end; }
    .payment-row select, .payment-row input { height: 36px; font-size: 11px; }
    .other-input-row { margin-top: 6px; }
    .btn-add-mode { background: #e0e7ff; color: #4338ca; border: none; font-size: 11px; height: 30px; margin-top: 8px; cursor: pointer; border-radius: 6px; width: auto; padding: 0 12px; }
    .btn-del-mode { background: #fee2e2; color: #ef4444; border: none; cursor: pointer; height: 36px; border-radius: 8px; padding: 0; }
    .cash-wrapper { border:1px solid var(--border-color); border-radius:12px; padding:12px; margin-top:12px; background: var(--bg-input); }
    .cash-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
    .cash-card { border:1px solid var(--border-color); border-radius:8px; padding:5px; text-align:center; background: var(--bg-card); }
    .cash-card span { display:block; font-size: 10px; font-weight:600; color: var(--text-label); }
    .cash-card input { width:100%; height:28px; text-align:center; margin-top: 2px; font-size: 11px; }
    .hidden { display:none !important }
    .sync-wrapper { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 15px; }
    #syncIndicator { font-size: 12px; color: var(--text-label); font-weight: 500; }
    #btnViewQueue { width: auto; height: 28px; font-size: 11px; background: var(--bg-card); padding: 0 12px; cursor: pointer; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 1000; display: flex; justify-content: center; align-items: center; }
    .modal-content { background: var(--bg-card); color: var(--text-main); width: 98%; max-width: 850px; max-height: 85vh; border-radius: 14px; display: flex; flex-direction: column; overflow: hidden; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: var(--bg-input); border-bottom: 1px solid var(--border-color); }
    .table-container { overflow-x: auto; padding: 10px; }
    table { width: 100%; border-collapse: collapse; font-size: 11px; min-width: 700px; }
    th { text-align: left; padding: 10px; border-bottom: 2px solid var(--border-color); color: var(--text-label); }
    td { padding: 10px; border-bottom: 1px solid var(--border-color); }
    #debugLog { font-size: 10px; color: #64748b; margin-top: 10px; text-align: center; display: block; }
  </style>
</head>

<body>
<form id="txnForm" novalidate>
  <div id="statusDot"></div>
  <h3>Monthly Transaction</h3>
  
  <label>Date</label>
  <input type="date" id="date" required>
  
  <label>Narration</label>
  <input type="text" id="narration" required placeholder="Description">
  
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
    <div>
      <label>Purpose</label>
      <select id="purpose" required onchange="toggleOtherField(this, 'purpose_other')">
        <option value="">Select</option>
        <option>Business</option><option>Donation</option><option>Entertainment</option><option>Food</option><option>Grocery</option><option>Hospital</option><option>House</option><option>Income</option><option>Insurance</option><option>Loan</option><option>Medicines</option><option>Puja</option><option>Travelling</option><option>Utility Bills</option><option value="Other">Other</option>
      </select>
      <input id="purpose_other" class="hidden other-input-row" placeholder="Specify Purpose" required disabled>
    </div>
    <div>
      <label>Spent For</label>
      <select id="spent_for" required onchange="toggleOtherField(this, 'spent_for_other')">
        <option value="">Select</option>
        <option>Self</option><option>House</option><option>Mother</option><option>Father</option><option>Family</option><option>Vasavi</option><option value="Other">Other</option>
      </select>
      <input id="spent_for_other" class="hidden other-input-row" placeholder="Specify Name" required disabled>
    </div>
  </div>

  <label>Flow</label>
  <select id="flow" required>
    <option value="">Select</option>
    <option value="withdraw">Withdraw</option>
    <option value="deposit">Deposit</option>
  </select>

  <label>Payment Breakdown</label>
  <div id="paymentContainer"></div>
  <button type="button" class="btn-add-mode" id="btnAddMode">+ Add Mode</button>

  <div id="cashBlock" class="hidden cash-wrapper">
    <div style="font-weight:600; color:#6366f1; margin-bottom:8px; font-size:12px;">Cash Denominations</div>
    <div class="cash-grid" id="cashGrid"></div>
  </div>

  <div class="btn-group">
    <button type="submit" id="submitBtn">Save Transaction</button>
    <button type="button" id="btnRepeat">‚Ü∫ Repeat</button>
  </div>

  <div class="sync-wrapper">
    <div id="syncIndicator" class="hidden"></div>
    <button type="button" id="btnViewQueue" class="hidden">View Queue</button>
  </div>
  <div id="debugLog">System Initializing...</div>
</form>

<div id="queueModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h4 style="margin:0">Offline Queue</h4>
      <span style="cursor:pointer; font-size: 20px;" onclick="document.getElementById('queueModal').classList.add('hidden')">‚úï</span>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Narration</th><th>Purpose</th><th>Account</th><th>Flow</th><th>Amount</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="queueBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbysvpY7m7Iw6CO6GPyrJFNR6hcs3bK3XVnEVIySYe-unbIc0kBh_c_TNaZ5mIiDRnRi/exec";
const bankAccounts = ["FI","HDFC Old","HDFC New","ICICI","IndusInd","Kotak","RBL","SBI"];
const creditCards = ["Axis Flipkart","Axis MyZone","Axis Neo","HDFC PhonePe","HDFC Tata Neu","HDFC Millennia","HSBC","IDFC First Millenia","ICICI Amazon","ICICI Coral","ICICI Expressions","Indusind Legend","SBI BPCL"];
const rewardPlatforms = ["Amazon", "Flipkart", "Supermoney", "Payzapp", "MobiKwik", "Tata Neu"];
const denoms = [500,200,100,50,20,10,5,2,1];

let db;
const DB_NAME = "TransactionManagerDB_v3", STORE_NAME = "txn_queue";

// --- Database Init ---
(function initDB(){
  try {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      e.target.result.createObjectStore(STORE_NAME, { autoIncrement: true });
    };
    req.onsuccess = e => { 
      db = e.target.result; 
      document.getElementById('debugLog').innerText = "Database Ready";
      updatePendingCount(); 
      checkStatus();
    };
    req.onerror = () => document.getElementById('debugLog').innerText = "Offline DB Error";
  } catch(e) { document.getElementById('debugLog').innerText = "DB Not Supported"; }
})();

function checkStatus() {
  const online = navigator.onLine;
  document.getElementById('statusDot').className = online ? 'online' : 'offline';
  if(online) syncOffline();
}
window.addEventListener('online', checkStatus);
window.addEventListener('offline', checkStatus);

function saveOffline(data){
  if (!db) return;
  const tx = db.transaction(STORE_NAME, "readwrite");
  tx.objectStore(STORE_NAME).add(data);
  tx.oncomplete = () => updatePendingCount();
}

async function syncOffline(){
  if (!navigator.onLine || !db) return;
  const tx = db.transaction(STORE_NAME, "readonly");
  const store = tx.objectStore(STORE_NAME);
  const req = store.getAll();
  req.onsuccess = async () => {
    const items = req.result; if (!items.length) return;
    for (let body of items) { 
      try { await fetch(SCRIPT_URL, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body }); } 
      catch (err) { return; } 
    }
    const writeTx = db.transaction(STORE_NAME, "readwrite");
    writeTx.objectStore(STORE_NAME).clear();
    writeTx.oncomplete = () => updatePendingCount();
  };
}

function updatePendingCount(){
  if(!db) return;
  db.transaction(STORE_NAME, "readonly").objectStore(STORE_NAME).getAll().onsuccess = (e) => {
    const items = e.target.result;
    document.getElementById("syncIndicator").textContent = items.length ? `‚è≥ ${items.length} Pending Offline` : "";
    document.getElementById("syncIndicator").classList.toggle("hidden", !items.length);
    document.getElementById("btnViewQueue").classList.toggle("hidden", !items.length);
    renderQueue(items);
  };
}

// --- Dynamic Fields ---
function toggleOtherField(selectObj, otherId) {
  const otherInput = document.getElementById(otherId);
  const isOther = selectObj.value === 'Other';
  otherInput.classList.toggle('hidden', !isOther);
  otherInput.disabled = !isOther;
  if(!isOther) otherInput.value = '';
}

function createPaymentRow(initial = null) {
  const wrapper = document.createElement('div');
  wrapper.className = 'payment-row-wrapper';
  wrapper.innerHTML = `
    <div class="payment-row">
      <div><select class="row-type" required><option value="">Type</option><option value="CASH">Cash</option><option value="DEBIT">Debit</option><option value="UPI">UPI</option><option value="NET">Net</option><option value="CREDIT">CC</option><option value="REWARDS">Rew</option></select></div>
      <div><select class="row-acc" required><option value="">Account</option></select></div>
      <div><input type="number" class="row-amt" placeholder="Amt" step="0.01" required></div>
      <button type="button" class="btn-del-mode">‚úï</button>
    </div>
    <input class="row-acc-other hidden other-input-row" placeholder="Specify Account" required disabled>
  `;
  
  const tSel = wrapper.querySelector('.row-type'), aSel = wrapper.querySelector('.row-acc'), amtInp = wrapper.querySelector('.row-amt'), otherAccInp = wrapper.querySelector('.row-acc-other');
  
  tSel.onchange = () => {
    const prevType = tSel.dataset.lastType;
    if(prevType === 'CASH' && tSel.value !== 'CASH') amtInp.value = '';
    aSel.innerHTML = '<option value="">Select</option>';
    if(tSel.value === 'CASH') { aSel.add(new Option("Cash", "Cash")); aSel.value = "Cash"; amtInp.readOnly = true; recalcCash(); }
    else {
      amtInp.readOnly = false;
      let list = (tSel.value === "CREDIT") ? creditCards : (tSel.value === "REWARDS" ? rewardPlatforms : bankAccounts);
      list.forEach(a => aSel.add(new Option(a, a)));
      aSel.add(new Option("Other", "Other"));
    }
    tSel.dataset.lastType = tSel.value;
    aSel.dispatchEvent(new Event('change'));
    toggleCashBlock();
  };

  aSel.onchange = () => {
    const isOther = aSel.value === 'Other';
    otherAccInp.classList.toggle('hidden', !isOther);
    otherAccInp.disabled = !isOther;
    if(!isOther) otherAccInp.value = '';
  };

  wrapper.querySelector('.btn-del-mode').onclick = () => { if(document.querySelectorAll('.payment-row-wrapper').length > 1) { wrapper.remove(); toggleCashBlock(); } };
  document.getElementById('paymentContainer').appendChild(wrapper);
  if(initial) { tSel.value = initial.type; tSel.onchange(); aSel.value = initial.acc; }
}

function recalcCash() {
  let tot = 0; document.querySelectorAll('.denom-input').forEach(i => tot += (i.value || 0) * i.dataset.val);
  document.querySelectorAll('.payment-row-wrapper').forEach(w => {
    if(w.querySelector('.row-type').value === 'CASH') w.querySelector('.row-amt').value = tot || "";
  });
}

function toggleCashBlock() {
  const hasCash = Array.from(document.querySelectorAll('.row-type')).some(s => s.value === 'CASH');
  document.getElementById('cashBlock').classList.toggle('hidden', !hasCash);
}

// --- Submit ---
document.getElementById('txnForm').onsubmit = async (e) => {
  e.preventDefault();
  const form = e.target;
  form.classList.add('was-validated');
  if (!form.checkValidity()) return;

  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.textContent = "Processing...";
  
  try {
    const payloads = [];
    document.querySelectorAll('.payment-row-wrapper').forEach(row => {
      const pFinal = document.getElementById('purpose').value === 'Other' ? document.getElementById('purpose_other').value : document.getElementById('purpose').value;
      const sFinal = document.getElementById('spent_for').value === 'Other' ? document.getElementById('spent_for_other').value : document.getElementById('spent_for').value;
      const accSel = row.querySelector('.row-acc');
      const aFinal = accSel.value === 'Other' ? row.querySelector('.row-acc-other').value : accSel.value;

      const p = new URLSearchParams({
        date: document.getElementById('date').value, narration: document.getElementById('narration').value,
        purpose: pFinal, spent_for: sFinal, flow: document.getElementById('flow').value,
        trtype: row.querySelector('.row-type').value, from_to: aFinal,
        withdrawn: document.getElementById('flow').value === 'withdraw' ? row.querySelector('.row-amt').value : 0,
        deposit: document.getElementById('flow').value === 'deposit' ? row.querySelector('.row-amt').value : 0,
        category: "monthly transactions"
      });
      if(row.querySelector('.row-type').value === "CASH") {
        document.querySelectorAll(".denom-input").forEach(i => p.append("d"+i.dataset.val, i.value || 0));
      }
      payloads.push(p.toString());
    });

    localStorage.setItem("lastPackage", JSON.stringify(payloads));

    for(let body of payloads) {
      if(!navigator.onLine) saveOffline(body);
      else { 
        try { await fetch(SCRIPT_URL, { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body }); } 
        catch { saveOffline(body); } 
      }
    }
    alert("Saved!");
    fullReset();
  } catch(err) { alert("An error occurred. Check input values."); }
  finally { btn.disabled = false; btn.textContent = "Save Transaction"; }
};

function fullReset() {
  const form = document.getElementById('txnForm');
  form.reset(); form.classList.remove('was-validated');
  document.querySelectorAll('.other-input-row').forEach(i => { i.classList.add('hidden'); i.disabled = true; });
  document.getElementById('paymentContainer').innerHTML = ""; createPaymentRow();
  document.getElementById('date').value = new Date().toISOString().split("T")[0];
  document.querySelectorAll('.denom-input').forEach(i => i.value = "");
  toggleCashBlock(); updatePendingCount();
}

// --- Utils ---
function renderQueue(items) {
  const body = document.getElementById('queueBody'); body.innerHTML = "";
  items.forEach((item, idx) => {
    const p = new URLSearchParams(item);
    body.innerHTML += `<tr><td>${p.get('date')}</td><td>${p.get('narration')}</td><td>${p.get('purpose')}</td><td>${p.get('from_to')}</td><td>${p.get('flow')}</td><td>${p.get('withdrawn') > 0 ? p.get('withdrawn') : p.get('deposit')}</td><td><button type="button" onclick="deleteQueue(${idx})" style="padding:0; width:30px; height:25px;">üóëÔ∏è</button></td></tr>`;
  });
}

window.deleteQueue = (idx) => {
  const tx = db.transaction(STORE_NAME, "readwrite");
  const store = tx.objectStore(STORE_NAME);
  store.getAll().onsuccess = (e) => {
    const req = store.openCursor();
    let count = 0;
    req.onsuccess = (ev) => {
      const cursor = ev.target.result;
      if(cursor) { if(count === idx) cursor.delete(); else { count++; cursor.continue(); } }
      updatePendingCount();
    };
  };
};

// Cash Init
denoms.forEach(v => {
  const c = document.createElement("div"); c.className = "cash-card";
  c.innerHTML = `<span>‚Çπ${v}</span><input type="number" data-val="${v}" class="denom-input" placeholder="0">`;
  c.querySelector('input').oninput = recalcCash;
  document.getElementById('cashGrid').appendChild(c);
});

document.getElementById('btnAddMode').onclick = () => createPaymentRow();
document.getElementById('btnViewQueue').onclick = () => document.getElementById('queueModal').classList.remove('hidden');
document.getElementById('btnRepeat').onclick = () => {
  const last = localStorage.getItem("lastPackage"); if(!last) return;
  const list = JSON.parse(last); document.getElementById('paymentContainer').innerHTML = "";
  list.forEach((s, idx) => {
    const p = new URLSearchParams(s);
    if(idx === 0) { document.getElementById('narration').value = p.get('narration'); document.getElementById('purpose').value = p.get('purpose'); document.getElementById('spent_for').value = p.get('spent_for'); document.getElementById('flow').value = p.get('flow'); }
    createPaymentRow({ type: p.get('trtype'), acc: p.get('from_to') });
  });
};

let lastTap = 0;
document.body.addEventListener('touchend', (e) => {
  const now = Date.now(); if(now - lastTap < 300) { document.body.classList.toggle('dark'); e.preventDefault(); }
  lastTap = now;
});
document.body.addEventListener('dblclick', () => document.body.classList.toggle('dark'));
document.getElementById('date').value = new Date().toISOString().split("T")[0];
createPaymentRow();
</script>
</body>
</html>
